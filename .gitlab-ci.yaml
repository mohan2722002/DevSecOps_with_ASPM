stages:
  - building
  - scan
  
variables:
  DOCKER_TLS_CERTDIR: ""

before_script:
  - docker info

build:
  stage: building
  tags:
    - centos  # Make sure your local GitLab runner is tagged this way
  script:
    - echo "ğŸš§ Building containers using Docker Compose..."
    - docker compose -f .build/docker-compose.yml up -d 


# Simple image vulnerability scanning
trivy-scan:
  stage: scan
  tags:
    - centos
  script:
    - echo "ğŸ” Scanning Docker images..."
    - |
      IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>")
      [ -z "$IMAGES" ] && { echo "âŒ No images found"; exit 1; }
      
      mkdir -p reports && echo "ğŸ“‹ Scanning $(echo "$IMAGES" | wc -l) images"
      
      echo "$IMAGES" | while read image; do
        echo "Scanning: $image"
        trivy image --format json --severity HIGH,CRITICAL \
          --output "reports/$(echo $image | tr ':/' '--').json" "$image"
      done
      
      echo "âœ… Scan complete. Reports in artifacts."
  artifacts:
    paths:
      - reports/
    expire_in: 1 week
  dependencies:
    - build