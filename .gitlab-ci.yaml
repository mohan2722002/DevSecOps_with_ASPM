stages:
  - build
  - scan
  
variables:
  DOCKER_TLS_CERTDIR: ""

before_script:
  - docker info

build:
  stage: build
  tags:
    - centos  # Make sure your local GitLab runner is tagged this way
  script:
    - echo "ğŸš§ Building containers using Docker Compose..."
    - docker compose -f .build/docker-compose.yml up -d 

# Add this to your existing stages


# Simple image vulnerability scanning
scan_images:
  stage: scan
  tags:
    - centos
  image: aquasec/trivy:latest
  script:
    - echo "ğŸ” Scanning Docker images..."
    # Get all built images and scan them
    - |
      for image in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>"); do
        echo "Scanning: $image"
        trivy image --severity HIGH,CRITICAL $image
      done
  dependencies:
    - build
