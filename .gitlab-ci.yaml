stages:
  - building
  - scan
  
variables:
  DOCKER_TLS_CERTDIR: ""

before_script:
  - docker info

build:
  stage: building
  tags:
    - centos  # Make sure your local GitLab runner is tagged this way
  script:
    - echo "üöß Building containers using Docker Compose..."
    - docker compose -f .build/docker-compose.yml up -d 


# Simple image vulnerability scanning
trivy-image-scan:
  stage: scan
  tags:
    - centos
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
    - mkdir -p ./bin
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ./bin
    - export PATH="$PWD/bin:$PATH"
  script:
    - echo "üîç Scanning Docker images..."
    - |
      for image in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>"); do
        echo "Scanning: $image"
        trivy image --format json --output "$(echo $image | tr ':/' '--')-report.json" $image
      done
  artifacts:
    paths:
      - "*-report.json"
  dependencies:
    - build