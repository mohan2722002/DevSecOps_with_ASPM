stages:
  - building
  - scan
  
variables:
  DOCKER_TLS_CERTDIR: ""

before_script:
  - docker info

build:
  stage: building
  tags:
    - centos  # Make sure your local GitLab runner is tagged this way
  script:
    - echo "ğŸš§ Building containers using Docker Compose..."
    - docker compose -f .build/docker-compose.yml up -d 


# Simple image vulnerability scanning
scan_images:
  stage: scan
  tags:
    - centos
  script:
    - echo "ğŸ” Installing Trivy..."
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - echo "ğŸ” Scanning Docker images..."
    # Get all built images and scan them
    - |
      for image in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>"); do
        echo "Scanning: $image"
        trivy image --severity HIGH,CRITICAL $image
      done
  dependencies:
    - build
