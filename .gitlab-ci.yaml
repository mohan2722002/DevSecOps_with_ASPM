stages:
  - sast

snyk-sast:
  stage: sast
  image: node:18
  before_script:
    - npm install -g snyk@latest
  script:
    - snyk auth $SNYK_TOKEN
    # Explicitly set working directory and ensure file is created
    - mkdir -p reports
    - cd reports && snyk code test --json-file=snyk-report.json || true
    - ls -l reports/snyk-report.json || echo "Report not generated" > reports/snyk-report.json
  artifacts:
    when: always
    paths:
      - reports/snyk-report.json
    reports:
      sast: reports/snyk-report.json
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH