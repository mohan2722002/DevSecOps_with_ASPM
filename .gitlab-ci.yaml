stages:
  - secret_scan
  - sca
  - sast
  - building
  - image_scan
  - container_security
  - dast

variables:
  DOCKER_TLS_CERTDIR: ""
  # Avoid storing secrets like SNYK_TOKEN in plaintext variables. Reference from a secured secret management system.
  # SNYK_TOKEN should be stored in a protected CI/CD variable or injected via a secrets manager (not committed here).
  # SNYK_TOKEN: ${SNYK_TOKEN}

# 1. Secret Scanning
gitleaks_scan:
  stage: secret_scan
  image:
    name: zricethezav/gitleaks:v8.18.2 # Pin to a specific version for supply chain integrity
    entrypoint: [""]
  script:
    - gitleaks detect --source . --report-format json --report-path gitleaks-report.json --verbose || true
  artifacts:
    paths:
      - gitleaks-report.json
    when: always
  rules:
    - exists:
        - '**/*'

# 2. SCA (Software Composition Analysis)
trivy-sca:
  stage: sca
  image: alpine:3.19  # Pin to a specific tag for deterministic builds
  before_script:
    - apk add --no-cache curl
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  script:
    - trivy fs --format json --output report.json --exit-code 0 .
  artifacts:
    paths:
      - report.json
  rules:
    - exists:
        - '**/*'

# 3. SAST (Static Application Security Testing)
snyk-sast:
  stage: sast
  image: node:18.20.0   # Pinning Node version
  before_script:
    - npm install -g snyk@1.1234.0 snyk-to-html@1.7.0   # Pin tool versions
  script:
    - snyk auth $SNYK_TOKEN
    - snyk code test --json-file=snyk-report.json || echo "Snyk found vulnerabilities - check report"
  artifacts:
    when: always
    paths:
      - snyk-report.json
    reports:
      sast: snyk-report.json
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  # Ensure SNYK_TOKEN provided via secure CI/CD variables or secret manager.

# 4. Building Image
build:
  stage: building
  tags:
    - centos
  script:
    - echo "üöß Building containers using Docker Compose..."
    - docker compose -f .build/docker-compose.yml up -d
  # Consider cleaning up resources after the build, e.g.:
    # - docker compose -f .build/docker-compose.yml down --volumes

# 5. Image Scanning
trivy-scan:
  stage: image_scan
  tags:
    - centos
  script:
    - echo "üîç Scanning Docker images..."
    - |
      IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>")
      [ -z "$IMAGES" ] && { echo "‚ùå No images found"; exit 1; }
      mkdir -p reports && echo "üìã Scanning $(echo "$IMAGES" | wc -l) images"
      echo "$IMAGES" | while read image; do
        echo "Scanning: $image"
        trivy image --format json --severity HIGH,CRITICAL \
          --output "reports/$(echo $image | tr ':/' '--').json" "$image"
      done
      echo "‚úÖ Scan complete. Reports in artifacts."
  artifacts:
    paths:
      - reports/
    expire_in: 1 week
  dependencies:
    - build

# 6. Container Security Scanning
container-runtime-scan:
  stage: container_security
  tags:
    - centos
  script:
    - echo "üîç Scanning running containers..."
    - |
      for container in $(docker ps --format "{{.ID}}"); do
        image=$(docker inspect $container --format='{{.Config.Image}}')
        echo "Scanning container $container (image: $image)"
        trivy image --severity HIGH,CRITICAL $image
      done
  dependencies:
    - build

# 7. DAST (Dynamic Application Security Testing)
zap_dast_scan:
  stage: dast
  tags:
    - centos
  variables:
    APP_URL: "http://localhost:80"
  script:
    - echo "Running ZAP baseline scan against $APP_URL"
    - mkdir -p zap-reports
    - chmod 777 zap-reports
    - docker run --rm --network="host" -v $(pwd)/zap-reports:/zap/wrk/:rw zaproxy/zap-stable:2.14.0 zap-baseline.py -t $APP_URL -r report.html || true  # Pin ZAP version
  artifacts:
    paths:
      - zap-reports/report.html
    expire_in: 1 week

# --- Optional: Audit logging placeholder example ---
# Consider integrating extended audit logging of stage outcomes via scripts or a centralized log collector.
