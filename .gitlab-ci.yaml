stages:
  - secret_scan
  - sca
  - sast
  - building
  - image_scan
  - container_security
  - dast
  - upload_results

variables:
  DOCKER_TLS_CERTDIR: ""

# 1. Secret Scanning
gitleaks_scan:
  stage: secret_scan
  image:
    name: zricethezav/gitleaks
    entrypoint: [""]
  script:
    - gitleaks detect --source . --report-format json --report-path gitleaks-report.json --verbose || true
  artifacts:
    paths:
      - gitleaks-report.json
    when: always

# 2. SCA (Software Composition Analysis)
trivy-sca:
  stage: sca
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  script:
    - trivy fs --format json --output report.json .
  artifacts:
    paths:
      - report.json

# 3. SAST (Static Application Security Testing)
snyk-sast:
  stage: sast
  image: node:18
  before_script:
    - npm install -g snyk snyk-to-html
  script:
    - snyk auth $SNYK_TOKEN
    - snyk code test --json-file=snyk-report.json || echo "Snyk found vulnerabilities - check report"
  artifacts:
    when: always
    paths:
      - snyk-report.json
    reports:
      sast: snyk-report.json
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# 4. Building Image
build:
  stage: building
  tags:
    - centos
  script:
    - echo "Building containers using Docker Compose..."
    - docker compose -f .build/docker-compose.yml up -d

# 5. Image Scanning
trivy-scan:
  stage: image_scan
  tags:
    - centos
  script:
    - echo "Scanning Docker images..."
    - |
      IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>")
      [ -z "$IMAGES" ] && { echo "No images found"; exit 1; }
     
      mkdir -p reports && echo "Scanning $(echo "$IMAGES" | wc -l) images"
     
      echo "$IMAGES" | while read image; do
        echo "Scanning: $image"
        trivy image --format json --severity HIGH,CRITICAL \
          --output "reports/$(echo $image | tr ':/' '--').json" "$image"
      done
     
      echo "Scan complete. Reports in artifacts."
  artifacts:
    paths:
      - reports/
    expire_in: 1 week
  dependencies:
    - build

# 6. Container Security Scanning
container-runtime-scan:
  stage: container_security
  tags:
    - centos
  script:
    - echo "Scanning running containers..."
    - |
      for container in $(docker ps --format "{{.ID}}"); do
        image=$(docker inspect $container --format='{{.Config.Image}}')
        echo "Scanning container $container (image: $image)"
        trivy image --severity HIGH,CRITICAL $image
      done
  dependencies:
    - build

# 7. DAST (Dynamic Application Security Testing)
zap_dast_scan:
  stage: dast
  tags:
    - centos
  variables:
    APP_URL: "http://localhost:80"
  script:
    - echo "Running ZAP baseline scan against $APP_URL"
    - mkdir -p zap-reports
    - chmod 777 zap-reports
    - docker run --rm --network="host" -v $(pwd)/zap-reports:/zap/wrk/:rw zaproxy/zap-stable zap-baseline.py -t $APP_URL -r report.html || true
  artifacts:
    paths:
      - zap-reports/report.html
    expire_in: 1 week

# 8. DefectDojo Upload
upload_to_defectdojo:
  stage: upload_results
  image: python:3.11
  before_script:
    - python3 -m pip install --upgrade pip
    - python3 -m pip install requests
  script:
    - python3 upload_reports.py gitleaks-report.json
    - python3 upload_reports.py report.json
    - python3 upload_reports.py snyk-report.json
  variables:
    DEFECTDOJO_API_KEY: $DEFECTDOJO_API_KEY
    DEFECTDOJO_ENGAGEMENT_ID: $DEFECTDOJO_ENGAGEMENT_ID
    DEFECTDOJO_API_URL: "http://65.20.88.177:8080"
  when: always
  needs: [gitleaks_scan, trivy-sca, snyk-sast]
  allow_failure: true