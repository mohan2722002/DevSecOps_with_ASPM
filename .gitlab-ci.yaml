stages:
  - secret_scan
  - sca
  - sast
  - building
  - image_scan
  - container_security
  - dast
  - upload_results

variables:
  DOCKER_TLS_CERTDIR: ""

# 1. Secret Scanning
gitleaks_scan:
  stage: secret_scan
  image:
    name: zricethezav/gitleaks
    entrypoint: [""]
  script:
    - gitleaks detect --source . --report-format json --report-path gitleaks-report.json --verbose || true
  artifacts:
    paths:
      - gitleaks-report.json
    when: always

# 2. SCA (Software Composition Analysis)
trivy-sca:
  stage: sca
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  script:
    - trivy fs --format json --output report.json .
  artifacts:
    paths:
      - report.json

# 3. SAST (Static Application Security Testing)
snyk-sast:
  stage: sast
  image: node:18
  before_script:
    - npm install -g snyk snyk-to-html
  script:
    - snyk auth $SNYK_TOKEN
    - snyk code test --json > snyk-report.json || echo "Snyk found vulnerabilities - check report"
    - echo "Checking if snyk-report.json was created..."
    - ls -la snyk-report.json || echo "snyk-report.json not found"
    - test -s snyk-report.json && echo "snyk-report.json has content" || echo "snyk-report.json is empty or missing"
  artifacts:
    when: always
    paths:
      - snyk-report.json
    reports:
      sast: snyk-report.json

# 4. Building Image
build:
  stage: building
  tags:
    - centos
  script:
    - echo "Building containers using Docker Compose..."
    - docker compose -f .build/docker-compose.yml up -d

# 5. Image Scanning
trivy-scan:
  stage: image_scan
  tags:
    - centos
  script:
    - echo "Scanning Docker images..."
    - |
      IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>")
      [ -z "$IMAGES" ] && { echo "No images found"; exit 1; }
     
      mkdir -p reports && echo "Scanning $(echo "$IMAGES" | wc -l) images"
     
      echo "$IMAGES" | while read image; do
        echo "Scanning: $image"
        trivy image --format json --severity HIGH,CRITICAL \
          --output "reports/$(echo $image | tr ':/' '--').json" "$image"
      done
     
      echo "Scan complete. Reports in artifacts."
  artifacts:
    paths:
      - reports/
    expire_in: 1 week
  dependencies:
    - build

# 6. Container Security Scanning
container-runtime-scan:
  stage: container_security
  tags:
    - centos
  script:
    - echo "Scanning running containers..."
    - |
      for container in $(docker ps --format "{{.ID}}"); do
        image=$(docker inspect $container --format='{{.Config.Image}}')
        echo "Scanning container $container (image: $image)"
        trivy image --severity HIGH,CRITICAL $image
      done
  dependencies:
    - build

# 7. DAST (Dynamic Application Security Testing)
zap_dast_scan:
  stage: dast
  tags:
    - centos
  variables:
    APP_URL: "http://localhost:80"
  script:
    - echo "Running ZAP baseline scan against $APP_URL"
    - mkdir -p zap-reports
    - chmod 777 zap-reports
    - docker run --rm --network="host" -v $(pwd)/zap-reports:/zap/wrk/:rw zaproxy/zap-stable zap-baseline.py -t $APP_URL -r zap-report.html || true
    - echo "Converting ZAP HTML report to XML for DefectDojo compatibility..."
    - docker run --rm --network="host" -v $(pwd)/zap-reports:/zap/wrk/:rw zaproxy/zap-stable zap-baseline.py -t $APP_URL -J zap-report.json || true
  artifacts:
    paths:
      - zap-reports/zap-report.html
      - zap-reports/zap-report.json
    expire_in: 1 week

# 8. DefectDojo Upload
upload_to_defectdojo:
  stage: upload_results
  image: python:3.11
  before_script:
    - python3 -m pip install --upgrade pip
    - python3 -m pip install requests
  script:
    - |
      echo "Checking for report files..."
      ls -la *.json || echo "No JSON files found in current directory"
      ls -la zap-reports/ || echo "No ZAP reports directory found"
      echo "Current directory contents:"
      ls -la
    - |
      # Upload reports that exist
      if [ -f "gitleaks-report.json" ]; then
        echo "Uploading gitleaks report..."
        python3 upload_reports.py gitleaks-report.json
      else
        echo "gitleaks-report.json not found"
      fi
      
      if [ -f "report.json" ]; then
        echo "Uploading trivy SCA report..."
        python3 upload_reports.py report.json
      else
        echo "report.json not found"
      fi
      
      if [ -f "snyk-report.json" ]; then
        echo "Uploading snyk SAST report..."
        python3 upload_reports.py snyk-report.json
      else
        echo "snyk-report.json not found"
      fi
      
      if [ -f "zap-reports/zap-report.json" ]; then
        echo "Uploading ZAP DAST report..."
        python3 upload_reports.py zap-reports/zap-report.json
      else
        echo "zap-report.json not found"
      fi
  variables:
    DEFECTDOJO_API_KEY: $DEFECTDOJO_API_KEY
    DEFECTDOJO_ENGAGEMENT_ID: $DEFECTDOJO_ENGAGEMENT_ID
    DEFECTDOJO_API_URL: "http://65.20.88.177:8080"
  when: always
  needs: 
    - job: gitleaks_scan
      artifacts: true
    - job: trivy-sca
      artifacts: true
    - job: snyk-sast
      artifacts: true
      optional: true
    - job: trivy-scan
      artifacts: true
      optional: true
    - job: container-runtime-scan
      optional: true
    - job: zap_dast_scan
      artifacts: true
      optional: true
  allow_failure: true