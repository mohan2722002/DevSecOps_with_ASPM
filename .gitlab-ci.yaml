stages:
  sast
snyk-sast:
  stage: sast
  image: node:18
  script:
    - npm install -g snyk
    - snyk auth $SNYK_TOKEN
    # This is the key fix - use --json-file instead of redirection
    - snyk code test --json-file=snyk-report.json || echo "Vulnerabilities found - check report"
  artifacts:
    when: always  # Critical for ensuring report upload
    paths:
      - snyk-report.json
    reports:
      sast: snyk-report.json