stages:
  - building
  - scan
  - runtime-security
variables:
  DOCKER_TLS_CERTDIR: ""

before_script:
  - docker info

build:
  stage: building
  tags:
    - centos  # Make sure your local GitLab runner is tagged this way
  script:
    - echo "üöß Building containers using Docker Compose..."
    - docker compose -f .build/docker-compose.yml up -d 


# Simple image vulnerability scanning
trivy-scan:
  stage: scan
  tags:
    - centos
  script:
    - echo "üîç Scanning Docker images..."
    - |
      IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>")
      [ -z "$IMAGES" ] && { echo "‚ùå No images found"; exit 1; }
      
      mkdir -p reports && echo "üìã Scanning $(echo "$IMAGES" | wc -l) images"
      
      echo "$IMAGES" | while read image; do
        echo "Scanning: $image"
        trivy image --format json --severity HIGH,CRITICAL \
          --output "reports/$(echo $image | tr ':/' '--').json" "$image"
      done
      
      echo "‚úÖ Scan complete. Reports in artifacts."
  artifacts:
    paths:
      - reports/
    expire_in: 1 week
  dependencies:
    - build


# This would be CONTAINER scanning
container-runtime-scan:
  stage: runtime-security
  tags:
    - centos
  script:
    - |
      for container in $(docker ps --format "{{.ID}}"); do
        trivy container $container
      done
  dependencies:
    - build