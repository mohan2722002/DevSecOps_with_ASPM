stages:
  - secret_scan
  - sca
  - sast
  - build
  - image_scan
  - container_security
  - dast
  - upload_results

variables:
  DOCKER_TLS_CERTDIR: ""
  APP_URL: "http://localhost:80"
  DEFECTDOJO_URL: "http://localhost:8080"

gitleaks_scan:
  stage: secret_scan
  image: zricethezav/gitleaks
  script:
    - gitleaks detect --source . --report-format json --report-path gitleaks-report.json --verbose || true
  artifacts:
    paths:
      - gitleaks-report.json
    when: always


# 2. Software Composition Analysis (SCA)
trivy_sca:
  stage: sca
  image: aquasec/trivy:latest
  script:
    - trivy fs --format json --output trivy-sca-report.json .
  artifacts:
    paths:
      - trivy-sca-report.json
    when: always

# 3. Static Application Security Testing (SAST)
snyk_sast:
  stage: sast
  image: node:18
  script:
    - npm install -g snyk snyk-to-html
    - snyk auth "$SNYK_TOKEN"
    - snyk code test --json-file=snyk-sast-report.json || echo "Snyk found issues"
  artifacts:
    paths:
      - snyk-sast-report.json
    when: always
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

# 4. Build Docker Images
build_image:
  stage: build
  tags:
    - docker
  script:
    - docker compose -f .build/docker-compose.yml up -d
  artifacts:
    paths:
      - .build/docker-compose.yml

# 5. Image Vulnerability Scanning
trivy_image_scan:
  stage: image_scan
  tags:
    - docker
  script:
    - |
      IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>")
      if [ -z "$IMAGES" ]; then
        echo "No images to scan"
        exit 0
      fi
      mkdir -p image-reports
      for image in $IMAGES; do
        trivy image --format json --severity HIGH,CRITICAL \
          --output "image-reports/$(echo $image | tr ':/' '__').json" "$image"
      done
  artifacts:
    paths:
      - image-reports/
    when: always
  dependencies:
    - build_image

# 6. Container Runtime Security Scanning
runtime_scan:
  stage: container_security
  tags:
    - docker
  script:
    - |
      for cid in $(docker ps -q); do
        img=$(docker inspect $cid --format='{{.Config.Image}}')
        trivy image --severity HIGH,CRITICAL "$img" > "container-security-$cid.json" || true
      done
  artifacts:
    paths:
      - container-security-*.json
    when: always
  dependencies:
    - build_image

# 7. Dynamic Application Security Testing (DAST)
zap_dast:
  stage: dast
  image: owasp/zap2docker-stable
  script:
    - mkdir -p zap-reports
    - zap-baseline.py -t "$APP_URL" -r zap-reports/zap-report.html || true
  artifacts:
    paths:
      - zap-reports/zap-report.html
    when: always

# 8. Upload Results to DefectDojo
upload_results:
  stage: upload_results
  tags:
    - dojo
  image: python:3.11
  before_script:
    - pip install --no-cache-dir requests
  script:
    - python3 upload_reports.py gitleaks-report.json
    - python3 upload_reports.py trivy-sca-report.json
    - python3 upload_reports.py snyk-sast-report.json
    - python3 upload_reports.py zap-reports/zap-report.html
    # Add any additional report uploads as needed
  variables:
    DEFECTDOJO_API_KEY: $DEFECTDOJO_API_KEY
    DEFECTDOJO_ENGAGEMENT_ID: $DEFECTDOJO_ENGAGEMENT_ID
    DEFECTDOJO_URL: $DEFECTDOJO_URL
  when: always
  needs:
    - gitleaks_scan
    - trivy_sca
    - snyk_sast
    - zap_dast
  allow_failure: true
