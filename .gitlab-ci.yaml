stages:
  - dependency_scanning

snyk-sca:
  stage: dependency_scanning
  image: node:18
  before_script:
    - npm install -g snyk snyk-to-html
    - npm install -g python3      # ensure Python is available
  script:
    - snyk auth $SNYK_TOKEN
    - snyk test --json > snyk-sca-report.json || echo "⚠️ Snyk SCA found vulnerabilities"
    # Convert Snyk JSON to GitLab's dependency scanning report format
    - python3 convert-snyk-to-gitlab.py
  artifacts:
    when: always
    paths:
      - snyk-sca-report.json
      - gl-dependency-scanning-report.json
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
  variables:
    SNYK_TOKEN: $SNYK_TOKEN
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
