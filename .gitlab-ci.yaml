stages:
  - build
  - zap_scan

variables:
  DOCKER_TLS_CERTDIR: ""

before_script:
  - docker info

build:
  stage: build
  tags:
    - centos  # Your registered GitLab Runner tag
  script:
    - echo "üöÄ Starting containers..."
    - docker compose -f .build/docker-compose.yml up -d
    - sleep 15

zap_scan:
  stage: zap_scan
  tags:
    - centos
  script:
    - echo "üïµÔ∏è Connecting ZAP container to app network..."
    - docker network connect datanet $(hostname)

    - echo "üïµÔ∏è Running ZAP scan (HTTP)..."
    - docker run --rm --user root -v $CI_PROJECT_DIR:/zap/wrk/:rw --network datanet zaproxy/zap-stable /zap/zap-baseline.py \
        -t http://www:80 -r zap_http_report.html -I

    - echo "üïµÔ∏è Running ZAP scan (HTTPS)..."
    - docker run --rm --user root -v $CI_PROJECT_DIR:/zap/wrk/:rw --network datanet zaproxy/zap-stable /zap/zap-baseline.py \
        -t https://www:443 -r zap_https_report.html -I -z "-config connection.ssl.certValidation=false"
  artifacts:
    paths:
      - zap_http_report.html
      - zap_https_report.html
    when: always
    expire_in: 1 week
