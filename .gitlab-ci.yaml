stages:
  - Secret_scanning
  - SCA
  - SAST
  - Image_building
  - Image_scanning
  - Container_scanning
  - DAST
  - Vulnerability_management

variables:
  DOCKER_TLS_CERTDIR: ""

# 1. Secret Scanning
gitleaks_scan:
  stage: Secret_scanning
  image:
    name: zricethezav/gitleaks
    entrypoint: [""]
  script:
    - gitleaks detect --source . --report-format json --report-path gitleaks-report.json --verbose || true
  artifacts:
    paths:
      - gitleaks-report.json
    when: always

# 2. SCA (Software Composition Analysis)
trivy_sca:
  stage: SCA
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  script:
    - trivy fs --format json --output report.json .
  artifacts:
    paths:
      - report.json

# 3. SAST (Static Application Security Testing)
snyk_sast:
  stage: SAST
  image: node:18
  before_script:
    - npm install -g snyk snyk-to-html
  script:
    - snyk auth $SNYK_TOKEN
    - snyk code test --json > snyk-report.json || echo "Snyk found vulnerabilities - check report"
    - echo "Checking if snyk-report.json was created..."
    - ls -la snyk-report.json || echo "snyk-report.json not found"
    - test -s snyk-report.json && echo "snyk-report.json has content" || echo "snyk-report.json is empty or missing"
  artifacts:
    when: always
    paths:
      - snyk-report.json
    reports:
      sast: snyk-report.json

# 4. Building Image
build:
  stage: Image_building
  tags:
    - centos
  script:
    - echo "Building containers using Docker Compose..."
    - docker compose -f .build/docker-compose.yml up -d

# 5. Image Scanning
trivy_scan:
  stage: Image_scanning
  tags:
    - centos
  script:
    - echo "Scanning Docker images..."
    - |
      IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>")
      [ -z "$IMAGES" ] && { echo "No images found"; exit 1; }
      
      mkdir -p reports && echo "Scanning $(echo "$IMAGES" | wc -l) images"
      
      echo "$IMAGES" | while read image; do
        echo "Scanning: $image"
        trivy image --format json --severity HIGH,CRITICAL \
          --output "reports/$(echo $image | tr ':/' '--').json" "$image"
      done
      
      echo "Scan complete. Reports in artifacts."
  artifacts:
    paths:
      - reports/
    expire_in: 1 week
  dependencies:
    - build

# 6. Container Security Scanning
container_runtime_scan:
  stage: Container_scanning
  tags:
    - centos
  script:
    - echo "Scanning running containers..."
    - |
      for container in $(docker ps --format "{{.ID}}"); do
        image=$(docker inspect $container --format='{{.Config.Image}}')
        echo "Scanning container $container (image: $image)"
        trivy image --severity HIGH,CRITICAL $image
      done
  dependencies:
    - build

#7 DAST
zap_dast_scan:
  stage: DAST
  tags:
    - centos
  variables:
    APP_URL: "http://localhost:80"
  script:
    - echo "Running ZAP full scan against $APP_URL"
    - mkdir -p zap-reports
    - chmod 777 zap-reports
    - docker run --rm --network="host" \
        -v $(pwd)/zap-reports:/zap/wrk/:rw \
        zaproxy/zap-stable zap-full-scan.py \
        -t $APP_URL -r zap-report.html -J zap-report.json || true
    - echo "ZAP scan complete. Checking generated files:"
    - ls -la zap-reports/
  artifacts:
    paths:
      - zap-reports/
    expire_in: 1 week
  dependencies:
    - build

# 8. DefectDojo Upload
upload_to_defectdojo:
  stage: Vulnerability_management
  image: python:3.11
  before_script:
    - python3 -m pip install --upgrade pip
    - python3 -m pip install requests
  script:
    - |
      echo "Checking for report files..."
      ls -la *.json || echo "No JSON files found in current directory"
      ls -la zap-reports/ || echo "No ZAP reports directory found"
      ls -la reports/ || echo "No Trivy reports directory found"
      echo "Current directory contents:"
      ls -la
    - |
      # Upload reports that exist
      if [ -f "gitleaks-report.json" ]; then
        echo "Uploading gitleaks report..."
        python3 upload_reports.py gitleaks-report.json
      else
        echo "gitleaks-report.json not found"
      fi
      
      if [ -f "report.json" ]; then
        echo "Uploading trivy SCA report..."
        python3 upload_reports.py report.json
      else
        echo "report.json not found"
      fi
      
      if [ -f "snyk-report.json" ]; then
        echo "Uploading snyk SAST report..."
        python3 upload_reports.py snyk-report.json
      else
        echo "snyk-report.json not found"
      fi
      
      # Upload Trivy image scan reports
      if [ -d "reports" ]; then
        echo "Uploading Trivy image scan reports..."
        for report_file in reports/*.json; do
          if [ -f "$report_file" ]; then
            echo "Uploading $report_file..."
            python3 upload_reports.py "$report_file"
          fi
        done
      else
        echo "No Trivy image scan reports directory found"
      fi
      
      # Upload ZAP DAST report  
      if [ -f "zap-reports/zap-report.json" ]; then
        echo "Uploading ZAP DAST report..."
        python3 upload_reports.py zap-reports/zap-report.json
      else
        echo "zap-report.json not found in zap-reports directory"
      fi
  variables:
    DEFECTDOJO_API_KEY: $DEFECTDOJO_API_KEY
    DEFECTDOJO_ENGAGEMENT_ID: $DEFECTDOJO_ENGAGEMENT_ID
    DEFECTDOJO_API_URL: "http://65.20.88.177:8080"
  when: always
  needs: 
    - job: gitleaks_scan
      artifacts: true
    - job: trivy_sca
      artifacts: true
    - job: snyk_sast
      artifacts: true
      optional: true
    - job: trivy_scan
      artifacts: true
      optional: true
    - job: container_runtime_scan
      optional: true
    - job: zap_dast_scan
      artifacts: true
      optional: true
  allow_failure: true